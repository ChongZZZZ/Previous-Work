<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartScheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        input, select {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        button {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background-color: #07a389;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 100px;
            cursor: pointer;
        }
        button:hover {
            background-color: #07a389;
        }
        #schedule, #nextTask {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .nav-links {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            list-style-type: none;
            padding: 0;
            margin-bottom: 20px;
        }
        .nav-links li {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            display: inline;
            margin-right: 10px;
        }
        .nav-links a {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-decoration: none;
            background-color: #0793a3;
            color: white;
            padding: 10px 40px;
            border: none;
            border-radius: 0px;
            cursor: pointer;
        }

        .nav-links b {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-decoration: none;
            background-color: #0793a3;
            color: white;
            padding: 10px 118px;
            border: none;
            border-radius: 0px;
            cursor: pointer;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .summary, .workload {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .summary-header {
            color: #0758a3;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .today-date {
            color: #666;
            font-size: 0.9em;
        }
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 45px;
            margin-top: 15px;
        }
        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1ec4e6;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .task-list {
            text-align: center;
        }
        
        .task-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .task-name, .task-time, .completion-time {
            font-weight: 500;
            text-align: center;
        }

        .task-time {
            color: #666;
        }

        .breakdown-table {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }
        .breakdown-table th, 
        .breakdown-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .breakdown-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .task-details {
            margin-top: 30px;
        }
        .week-range {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .finished-task {
            background-color: #f0f0f0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SmartScheduler</h1>
        <ul class="nav-links">
            <li><a href="#" onclick="showSection('setWorkBlock')">Set Work Block</a></li>
            <li><a href="#" onclick="showSection('addClass')">Add Class</a></li>
            <li><a href="#" onclick="showSection('addTask')">Add Task</a></li>
            <li><a href="#" onclick="showSection('dailySchedule')">Daily Schedule</a></li>
        </ul>

        <ul class="nav-links">
            <li><b href="#" onclick="showSection('dailySummary')">Daily Summary</b></li>
            <li><b href="#" onclick="showSection('weeklySummary')">Weekly Summary</b></li>
        </ul>

        <div id="setWorkBlock" class="section">
            <h2>Set Work Block</h2>
            <select id="workBlockDay">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
            <input type="time" id="workBlockStart" placeholder="Start Time">
            <input type="time" id="workBlockEnd" placeholder="End Time">
            <button onclick="setWorkBlock()">Set Work Block</button>
        </div>

        <div id="addClass" class="section">
            <h2>Add Class</h2>
            <input type="text" id="className" placeholder="Class Name">
            <input type="text" id="classDays" placeholder="Class Days (comma-separated)">
            <input type="time" id="classStart" placeholder="Start Time">
            <input type="time" id="classEnd" placeholder="End Time">
            <button onclick="addClass()">Add Class</button>
        </div>

        <div id="addTask" class="section">
            <h2>Add Task</h2>
            <input type="text" id="taskName" placeholder="Task Name">
            <input type="date" id="taskDeadline" placeholder="Deadline">
            
            <small>Tag</small>
            <select id="taskTag">
                <option value="reading">Reading</option>
                <option value="project">Project</option>
                <option value="writing">Writing</option>
            </select>
            
            <input type="text" id="newTag" placeholder="Add New Tag" onkeypress="addCustomTag(event)">
            <small>Estimated Finish Time</small>
            <input type="number" id="taskEstimatedTime" placeholder="Estimated Time (minutes)">
            <button onclick="addTask()">Add Task</button>
        </div>
        

        <div id="dailySchedule" class="section">
            <h2>Daily Schedule</h2>
            <button onclick="getDailySchedule()">Get Today's Schedule</button>
            <div id="schedule"></div>

            <h3>Next Recommended Task</h3>
            <select id="currentEnergy">
                <option value="low">Low Energy</option>
                <option value="medium">Medium Energy</option>
                <option value="high">High Energy</option>
            </select>
            <button onclick="getNextTask()">Get Next Task</button>
            <div id="nextTask"></div>
        </div>

        <div id="dailySummary" class="section">
            <h2>Daily Summary</h2>
            <div id="dailySummaryContent" class="summary"></div>
        </div>

        <div id="weeklySummary" class="section">
            <h2>Weekly Summary</h2>
            <div id="weeklySummaryContent" class="summary"></div>
        </div>
    </div>

    <script>
        function setWorkBlock() {
            const day = document.getElementById('workBlockDay').value;
            const start = document.getElementById('workBlockStart').value;
            const end = document.getElementById('workBlockEnd').value;
            
            axios.post('/set_work_block', {
                [day]: { start, end }
            })
            .then(response => alert(response.data.message));
        }

        function addClass() {
            const name = document.getElementById('className').value;
            const days = document.getElementById('classDays').value.split(',').map(day => day.trim());
            const start_time = document.getElementById('classStart').value;
            const end_time = document.getElementById('classEnd').value;

            axios.post('/add_class', { name, days, start_time, end_time })
            .then(response => alert(response.data.message));
        }

       // Initialize a set to keep track of unique tags
        const customTags = new Set(['reading', 'project', 'writing']);

        function addTask() {
            const name = document.getElementById('taskName').value;
            const deadline = document.getElementById('taskDeadline').value;
            let tag = document.getElementById('taskTag').value;
            const estimated_time = document.getElementById('taskEstimatedTime').value;
        
            const newTagInput = document.getElementById('newTag').value.trim();
            if (newTagInput) {
                tag = newTagInput;
            }
        
            axios.post('/add_task', { name, deadline, tag, estimated_time })
                .then(response => {
                    alert(response.data.message);
        
                    if (!customTags.has(tag)) {
                        customTags.add(tag);
                        const tagSelect = document.getElementById('taskTag');
                        const newOption = document.createElement('option');
                        newOption.value = tag;
                        newOption.text = tag;
                        tagSelect.appendChild(newOption);
                    }
        

                    document.getElementById('taskTag').value = tag;
                    document.getElementById('taskName').value = '';
                    document.getElementById('taskDeadline').value = '';
                    document.getElementById('taskEstimatedTime').value = '';
                    document.getElementById('newTag').value = '';
                })
                .catch(error => console.error('Error:', error));
        }
        
        function addCustomTag(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const newTagInput = document.getElementById('newTag');
                const newTag = newTagInput.value.trim();
                
                if (newTag && !customTags.has(newTag)) { 
                    customTags.add(newTag);
                    const tagSelect = document.getElementById('taskTag');
                    const newOption = document.createElement('option');
                    newOption.value = newTag;
                    newOption.text = newTag;
                    tagSelect.appendChild(newOption);
                    newTagInput.value = '';
                    tagSelect.value = newTag;
                } 
            }
        }

        const finishedTasks = new Set();

        function getDailySchedule() {
            const todayStr = getChicagoDateString();
    
            axios.get(`/update_daily_schedule?date=${todayStr}`)
                .then(response => {
                    const schedule = response.data;
                    let scheduleHtml = `<h3>Schedule for ${todayStr}</h3>`;
                    scheduleHtml += '<table><tr><th>Time</th><th>Activity</th><th>Action</th></tr>';
                    const classes = [];
                    const tasks = [];
                    
                    // Separate classes and tasks
                    schedule.forEach(item => {
                        if (item.type === 'class') {
                            classes.push({
                                type: 'class',
                                name: item.name,
                                start_time: new Date(`2000-01-01T${item.start_time}`),
                                end_time: new Date(`2000-01-01T${item.end_time}`)
                            });
                        } else if (item.type === 'working_hours') {
                            let currentTime = new Date(`2000-01-01T${item.start_time}`);
                            const workEnd = new Date(`2000-01-01T${item.end_time}`);
        
                            item.tasks.forEach(task => {
                                let taskStart = currentTime;
                                let taskEnd;
                                
                                // If task is finished, use actual_time for duration
                                if (task.finished && task.actual_time) {
                                    taskEnd = new Date(taskStart.getTime() + task.actual_time * 60000);
                                } else {
                                    taskEnd = new Date(taskStart.getTime() + task.estimated_time * 60000);
                                }
                                
                                // Check if the task start overlaps with any class
                                for (const cls of classes) {
                                    if (taskStart < cls.end_time && taskEnd > cls.start_time) {
                                        taskStart = cls.end_time;
                                        taskEnd = new Date(taskStart.getTime() + (task.finished ? task.actual_time : task.estimated_time) * 60000);
                                    }
                                }
        
                                if (taskEnd <= workEnd) {
                                    tasks.push({
                                        type: 'task',
                                        name: task.name,
                                        start_time: taskStart,
                                        end_time: taskEnd,
                                        deadline: task.deadline,
                                        finished: task.finished || finishedTasks.has(task.name),
                                        estimated_time: task.estimated_time,
                                        actual_time: task.actual_time
                                    });
                                    currentTime = taskEnd;
                                }
                            });
                        }
                    });
        
                    const unifiedSchedule = [...classes, ...tasks].sort((a, b) => a.start_time - b.start_time);
        
                    unifiedSchedule.forEach(item => {
                        if (item.type === 'class') {
                            scheduleHtml += `
                                <tr>
                                    <td>${item.start_time.toTimeString().slice(0, 5)} - ${item.end_time.toTimeString().slice(0, 5)}</td>
                                    <td>${item.name}</td>
                                    <td>Scheduled</td>
                                </tr>
                            `;
                        } else if (item.type === 'task') {
                            const buttonHtml = item.finished
                                ? '<span>Finished</span>' 
                                : `<button onclick="markTaskFinished('${item.name}', ${item.estimated_time})">Finish</button>`;
                            
                            scheduleHtml += `
                                <tr class="${item.finished ? 'finished-task' : ''}">
                                    <td>${item.start_time.toTimeString().slice(0, 5)} - ${item.end_time.toTimeString().slice(0, 5)}</td>
                                    <td>${item.name} (Due: ${item.deadline})</td>
                                    <td>${buttonHtml}</td>
                                </tr>
                            `;
                        }
                    });
        
                    scheduleHtml += '</table>';
                    document.getElementById('schedule').innerHTML = scheduleHtml;
                })
                .catch(error => {
                    console.error('Error fetching schedule:', error);
                    document.getElementById('schedule').innerHTML = `<p style="color: red;">Error loading schedule: ${error.message}</p>`;
                });
        }
        
        function getChicagoTime() {
            return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Chicago"}));
        }

        function markTaskFinished(taskName, estimatedTime) {
            const actualTime = prompt(`Enter the actual time taken to complete "${taskName}" (in minutes):`, estimatedTime);
            if (actualTime === null) return;
        
            const currentEnergy = document.getElementById('currentEnergy').value;
        
            axios.post('/mark_task_finished', {
                task_name: taskName,
                actual_time: parseInt(actualTime),
                current_energy: currentEnergy
            })
            .then(response => {
                finishedTasks.add(taskName);
                
                const taskRows = document.querySelectorAll('tr');
                for (const row of taskRows) {
                    const taskCell = row.querySelector('td:nth-child(2)');
                    if (taskCell && taskCell.textContent.includes(taskName)) {
                        const timeCell = row.querySelector('td:nth-child(1)');
                        const startTime = timeCell.textContent.split(' - ')[0];
                        
                        // Calculate new end time
                        const [hours, minutes] = startTime.split(':').map(Number);
                        const startDate = new Date(2000, 0, 1, hours, minutes);
                        const endDate = new Date(startDate.getTime() + parseInt(actualTime) * 60000);
                        const endTime = endDate.toTimeString().slice(0, 5);
                        
                        timeCell.textContent = `${startTime} - ${endTime}`;
                        row.querySelector('td:nth-child(3)').innerHTML = '<span>Finished</span>';
                        row.classList.add('finished-task');
                        break;
                    }
                }
        
                if (document.getElementById('dailySummary').classList.contains('active')) {
                    getDailySummary();
                }
        
                const recommendedTaskButton = document.querySelector(`#nextTask button[onclick*="${taskName}"]`);
                if (recommendedTaskButton) {
                    recommendedTaskButton.parentElement.innerHTML = '<span>Finished</span>';
                }
            })
            .catch(error => console.error('Error:', error));
        }


        function getNextTask() {
            const currentEnergy = document.getElementById('currentEnergy').value;
            
            axios.post('/get_next_task', {
                user_preferences: { tag: 'reading', priority: 0.5, estimated_time: 60 },
                current_energy: currentEnergy
            })
            .then(response => {
                const task = response.data;
                let taskHtml = '<h3>Next Recommended Task</h3>';
                if (task.name) {
                    taskHtml += `
                        <p>Name: ${task.name}</p>
                        <p>Deadline: ${task.deadline}</p>
                        <p>Tag: ${task.tag}</p>
                        <p>Estimated Time: ${task.estimated_time} minutes</p>
                        <button onclick="markTaskFinished('${task.name}', ${task.estimated_time})">Mark as Finished</button>
                    `;
                } else {
                    taskHtml += '<p>No tasks available</p>';
                }
                document.getElementById('nextTask').innerHTML = taskHtml;
            })
            .catch(error => console.error('Error:', error));
        }


        function updateUI() {
            getDailySchedule();
            getNextTask();
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) {
                return `${mins}m`;
            }
            return `${hours}h ${mins}m`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'America/Chicago'
            });
        }

        function getChicagoDateString() {
            const options = { 
                timeZone: 'America/Chicago',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            const chicagoDate = new Date().toLocaleString('en-US', options);
            const [month, day, year] = chicagoDate.split('/');
            return `${year}-${month}-${day}`;
        }

        function getDailySummary() {
            const todayStr = getChicagoDateString();
    
            axios.get(`/get_daily_summary?date=${todayStr}`)
            .then(response => {
                const summary = response.data;
                let summaryHtml = `
                    <div class="summary-card">
                        <div class="summary-header">
                            <div>
                                <div class="today-date">Today</div>
                            </div>
                        </div>
                        
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-label">Tasks Completed</div>
                                <div class="stat-value">${summary.completed_tasks}</div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-label">Total Study Time</div>
                                <div class="stat-value">${formatTime(summary.total_study_time)}</div>
                            </div>
                        </div>`;

                if (summary.tasks && summary.tasks.length > 0) {
                    summaryHtml += `
                        <div class="task-list">
                            <h4>Completed Tasks</h4>
                            <div class="task-item task-header">
                                <div>Task Name</div>
                                <div>Time Spent</div>
                            </div>
                            ${summary.tasks.map(task => `
                                <div class="task-item">
                                    <div class="task-name">${task.name}</div>
                                    <div class="task-time">${formatTime(task.time_spent)}</div>
                                </div>
                            `).join('')}
                        </div>`;
                } else {
                    summaryHtml += `
                        <div class="task-list">
                            <p style="text-align: center; color: #666;">No tasks completed yet today</p>
                        </div>`;
                }

                summaryHtml += `</div>`;
                document.getElementById('dailySummaryContent').innerHTML = summaryHtml;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('dailySummaryContent').innerHTML = 
                    `<div class="summary-card">
                        <p style="color: red;">Error loading summary: ${error.message}</p>
                     </div>`;
            });
        }

        function getWeeklySummary() {
            const today = getChicagoTime();
            
            // Retrieve the summary from the backend, with start_date calculated in Python
            axios.get(`/get_weekly_summary`)
                .then(response => {
                    const summary = response.data;
                    
                    // Calculate the week based on the Python-provided start_date
                    const startDate = new Date(summary.start_date);
                    const endDate = new Date(summary.end_date);
                    
                    // Construct orderedDays array for each day from startDate to endDate
                    const orderedDays = [];
                    for (let i = 0; i <= 6; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + i);
        
                        const currentDateStr = currentDate.toISOString().split('T')[0];
        
                        // Find the day's breakdown data or default to zero values
                        const dayData = summary.daily_breakdown.find(day => day.date === currentDateStr) || {
                            date: currentDateStr,
                            completed_tasks: 0,
                            study_time: 0
                        };
        
                        orderedDays.push(dayData);
                    }
        
                    // Generate HTML output
                    let summaryHtml = `
                        <div class="summary-card">
                            <div class="week-range">
                            This week
                            </div>
                            
                            <div class="stat-grid">
                                <div class="stat-item">
                                    <div class="stat-label">Tasks Completed</div>
                                    <div class="stat-value">${summary.completed_tasks}</div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-label">Total Study Time</div>
                                    <div class="stat-value">${formatTime(summary.total_study_time)}</div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-label">Daily Average</div>
                                    <div class="stat-value">${formatTime(Math.round(summary.total_study_time / 7))}</div>
                                </div>
                            </div>
        
                            <div style="margin-top: 30px;">
                                <h4>Daily Breakdown</h4>
                                <table class="breakdown-table">
                                    <tr>
                                        <th>Day</th>
                                        <th>Tasks Done</th>
                                        <th>Study Time</th>
                                    </tr>
                                    ${orderedDays.sort((a, b) => {
                                        const dayOrder = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
                                        return dayOrder[new Date(a.date).toLocaleDateString('en-US', { weekday: 'long' })] - 
                                            dayOrder[new Date(b.date).toLocaleDateString('en-US', { weekday: 'long' })];
                                    }).map(day => {
                                        // Create a new date object, add one day, and format it
                                        const nextDay = new Date(day.date);
                                        nextDay.setDate(nextDay.getDate() + 1);
                                        return `
                                            <tr>
                                                <td>${nextDay.toLocaleDateString('en-US', { weekday: 'long' })}</td>
                                                <td>${day.completed_tasks}</td>
                                                <td>${formatTime(day.study_time)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </table>


                            </div>
    
                            </div>
                    `;
                    document.getElementById('weeklySummaryContent').innerHTML = summaryHtml;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('weeklySummaryContent').innerHTML = 
                        `<div class="summary-card">
                            <p style="color: red;">Error loading weekly summary: ${error.message}</p>
                         </div>`;
                });
        } 
        
        

        // Modify showSection to call getWeeklySummary when that section is shown
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'dailySummary') {
                getDailySummary();
            } else if (sectionId === 'weeklySummary') {
                getWeeklySummary();
            }
        }
        // Set default date to today and load schedule on page load
        window.onload = function() {
            showSection('dailySchedule');
            updateUI();
        }
    </script>
</body>
</html>